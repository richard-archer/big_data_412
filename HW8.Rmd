---
title: "BUS 41201 Homework 8"
author: Andy Walsh, Richard Archer, Grace Park, Riya Malik
date: "5/18/2019"
fontsize: 10 pt
output: 
    pdf_document:
        fig_width: 6
        fig_height: 4
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      #include = TRUE, 
                      fig.width = 6, fig.height = 4,
                      results='hide',
                      warning = FALSE,
                      cache = TRUE,
                      digits = 3,
                      width = 48) 
library(dplyr)
library(igraph)
library(arules)
library(textir)
library(maptpx)
library(wordcloud)
library(gamlr)
library(foreign)
library(haven)
library(tidyverse)
library(tree)
library(randomForest)
library(class)
library(plyr)
library(bnstruct)
library(gdata)
library(readxl)
library(janitor)
library(bigmemory)
library(biglasso)
library(methods)
```


```{r}
#read in survey data
ts<-read_dta("./Data/ANES/anes_timeseries_2016.dta")
```

```{r}
#Combining all the turnout info

#read in the turnout data
upto2k14<-read.csv("./Data/1980-2014 November General Election - Turnout Rates.csv", skip=1, header=T)
to2k16<-read.csv("./Data/2016 November General Election - Turnout Rates.csv", skip=1, header=T)
to2k18<-read.csv("./Data/2018 November General Election - Turnout Rates.csv", skip=1, header=T)

#read in state as x for some reason
colnames(upto2k14)[colnames(upto2k14)=="X"]<-"State"



#change "State Abv" to "Abbreviation" for matching purposes
colnames(to2k16)[colnames(to2k16)=="State.Abv"]<-"Abbreviation"
colnames(to2k18)[colnames(to2k18)=="State.Abv"]<-"Abbreviation"

#change #Total.Ballots.Counted..Estimate to Total.Ballots.Counted for matching
colnames(to2k16)[colnames(to2k16)=="Total.Ballots.Counted..Estimate."]<-"Total.Ballots.Counted"
colnames(to2k18)[colnames(to2k18)=="Total.Ballots.Counted..Estimate."]<-"Total.Ballots.Counted"

#add year variables
to2k16$Year<-2016
to2k18$Year<-2018

#get rid of united states rows
upto2k14<-upto2k14[upto2k14$State != "United States",]
to2k16<-to2k16[to2k16$State !=  "United States",]
to2k18<-to2k18[to2k18$State != "United States",]

bad_2k14<-c("ICPSR.State.Code", "Alphanumeric.State.Code")
bad_other<-c("State.Results.Website", "Status")

upto2k14<-upto2k14[,!(names(upto2k14)%in% bad_2k14)]
to2k16<-to2k16[,!(names(to2k16)%in% bad_other)]
to2k18<-to2k18[,!(names(to2k18)%in% bad_other)]

head(upto2k14)
head(to2k16)


#dataframes of regions from aes data, done manually
NE<-data.frame(Abbreviation=c("CT", "ME", "MA", "NH", "NJ", "NY", "PA", "RI", "VT"))
NC<-data.frame(Abbreviation=c("IL", "IN", "IA", "KS", "MI", "MN", "MO", "NE", "ND"
, "OH", "SD", "WI"))
South<-data.frame(Abbreviation=c("AL", "AR", "DE", "D.C.", "FL", "GA", "KY", "LA", "MD", "MS", "NC", "OK", "SC","TN", "TX", "VA", "WV"))
West<-data.frame(Abbreviation=c("AK", "AZ", "CA", "CO", "HI", "ID", "MT", "NV", "NM", "OR", "UT", "WA", "WY"))

#name the regions
NE$Region<-"NE"
NC$Region<-"NC"
South$Region<-"South"
West$Region<-"West"

#combine the regions with region labels
reg_converter<-rbind(NE, NC, South, West)

#contains state names and abbreviations
state_converter1<-read.csv("./Data/State_converter.txt")

#add DC converter
dc_converter<-data.frame(State="District of Columbia", Abbreviation="D.C.")
state_converter<-rbind(state_converter1, dc_converter)

#add abbreviations to pre 2014 turnout data
turnout2<-merge(upto2k14, state_converter, by="State")


#col_comp<-Map(names(turnout2), names(to2k16), 
              #names(to2k18))

#to2k16$Total.Ballots.Counted<-

col_df<-data.frame(X=colnames(turnout2), Y=colnames(to2k16))

col_df



turnout2<-select(turnout2, colnames(to2k16))
#all turnout df

colnames(turnout2)
colnames(to2k16)
colnames(to2k18)
#excluding 2018 for now
turnout<-rbind(turnout2, to2k16)#, to2k18)

#add regions to turnout data
turnout_reg<-merge(turnout, reg_converter, by="Abbreviation")

head(turnout_reg)
```

```{r}
#V161011 <- registered to vote
#V161010e <- state abr
#V161019 <- registered party
#V161030 <- intend to vote
#V161031 <- candidate intended
#V161241 <- is religion important

subset(ts, V161030 & V161010e=="CA")
subset(turnout_reg, (Abbreviation=="CA") & (Year==2016))
dim(subset(ts, V161010e=="CA"))
```

```{r}

names(ts)[sapply(ts,class)=="double"]

labelled<-names(ts)[sapply(ts, class)=="haven_labelled"]
ts[, labelled]<-sapply(ts[,labelled], as.numeric)
#sapply(ts, class)

ts$V161001
```

```{r}

#-7 to -1 correspond to NaN, will use these as references
#-8, -9, 998, 999 will be imputed with KNN

ts[ts>100]<-NaN
ts[(ts<0)&(ts>-8)]<-NaN

na_count1 <-sapply(ts, function(y) sum(length(which(is.na(y)))))

na_count1/nrow(ts)

knn.impute(as.matrix(ts[na_count1/nrow(ts)<0.5]), k=5)

na_count2 <-sapply(ts, function(y) sum(length(which(is.na(y)))))

na_count2/nrow(ts)

#tr<-ts[(ts>0)&(ts<100)]

#te<-ts[(ts==-8)|(ts==-9)|(ts==998)|(ts==999)]

#ts[is.na(ts)]<-knn.cv(train=tr, test=te, cl=)

```


```{r}
#campaign finance stuff
cf15_16<-read.csv("./Data/CF/Contributions_15-16.csv")
head(cf15_16)
```

```{r}
cf_cols<-c("committee_name", "report_year", "entity_type", "recipient_name", "recipient_state", "disbursement_description", "disbursement_date", "disbursement_amount", "fec_election_type_desc", "fec_election_year")

cf15_16<-cf15_16[, cf_cols]
unique(cf15_16$committee_name)



p<-c("OBAMA FOR AMERICA"=="D")

#cf15_16$party<-apply(cf15_16$committee_name, 2, function(x) {x <- revalue(x, p); x})

head(cf15_16)

com_agg<-aggregate(cf15_16$disbursement_amount, by=list(Comittee=cf15_16$committee_name), sum)


colnames(com_agg)[colnames(com_agg)=="x"]<-"Spending"
cut_df<-as.data.frame(com_agg)[com_agg$Spending>1000000,]

```

```{r}
#use this to figure out which candidates are most importatnt
cut_df$Comittee

#removes rows with NaN in specific column
completeFun <- function(data, desiredCols) {
  completeVec <- complete.cases(data[, desiredCols])
  return(data[completeVec, ])
}

#important candidate comittees, based on party
dems<-data.frame(cands=c("OBAMA FOR AMERICA", "HILLARY FOR AMERICA", "BERNIE 2016", "COMMITTEE TO ELECT LLOYD KELSO PRESIDENT", "ROCKY 2016 LLC", "O'MALLEY FOR PRESIDENT", "WILLIE WILSON 2016"))

reps<-data.frame(cands=c("CRUZ FOR PRESIDENT", "CARLY FOR PRESIDENT", "CARSON AMERICA", "DONALD J. TRUMP FOR PRESIDENT, INC.", "JEB 2016, INC.", "MARCO RUBIO FOR PRESIDENT", "CHRIS CHRISTIE FOR PRESIDENT INC", "PERRY FOR PRESIDENT INC", "SANTORUM FOR PRESIDENT 2016", "LINDSEY GRAHAM 2016", "RAND PAUL FOR PRESIDENT, INC.", "HUCKABEE FOR PRESIDENT, INC.", "SCOTT WALKER INC", "KASICH FOR AMERICA INC", "FRIENDS OF HERMAN CAIN INC"))

ind<-data.frame(cands=c("MCMULLIN FOR PRESIDENT COMMITTEE INC.", "GARY JOHNSON 2016", "JILL STEIN FOR PRESIDENT"))

#assign party labels 
cf15_16$party[cf15_16$committee_name %in% dems$cands]<-"D"
cf15_16$party[cf15_16$committee_name %in% reps$cands]<-"R"
cf15_16$party[cf15_16$committee_name %in% ind$cands]<-"I"

#remove NaN from parties (ie remove not important candidates)
cf15_16<-completeFun(cf15_16, "party")

#aggregate based on party and state
com_agg2<-aggregate(disbursement_amount~party+recipient_state, cf15_16, sum)
#change state colname for matching purposes
colnames(com_agg2)[colnames(com_agg2)=="recipient_state"]<-"Abbreviation"
```

```{r}
#just 2016 turnout info
turnout_16<-subset(turnout_reg, Year==2016)

#disbursements by state
dem_CF<-subset(com_agg2, party=="D", select=c("disbursement_amount", "Abbreviation"))
rep_CF<-subset(com_agg2, party=="R", select=c("disbursement_amount", "Abbreviation"))
ind_CF1<-subset(com_agg2, party=="I", select=c("disbursement_amount", "Abbreviation"))
AR_df<-data.frame(disbursement_amount=0, Abbreviation="AR")
ind_CF<-rbind(ind_CF1, AR_df)
```

```{r}
#add CF to turnout df

#merge each parties spending by state, and renaming each column appropriately after
#theres probably a better way to do this but whatever
CF_turnout1<-merge(turnout_16, dem_CF, by="Abbreviation")
colnames(CF_turnout1)[colnames(CF_turnout1)=="disbursement_amount"]<-"Dem.CF"
CF_turnout2<-merge(CF_turnout1, rep_CF, by="Abbreviation")
colnames(CF_turnout2)[colnames(CF_turnout2)=="disbursement_amount"]<-"Rep.CF"
CF_turnout3<-merge(CF_turnout2, ind_CF, by="Abbreviation")
colnames(CF_turnout3)[colnames(CF_turnout3)=="disbursement_amount"]<-"Ind.CF"

CF_turnout3$Ind.CF[CF_turnout3$Abbreviation=="AR" ]<-0

#CF_turnout3[CF_turnout3$Abbreviation=="AR",]

#dim(rep_CF)
#state_converter$Abbreviation
#CF_turnout2$Abbreviation[CF_turnout2$Abbreviation %in% state_converter1$Abbreviation]
#ind_CF$Abbreviation[ind_CF$Abbreviation %in% state_converter1$Abbreviation]
#$Abbreviation
#dim(CF_turnout1)
#dim(CF_turnout2)
#dim(CF_turnout3)
```

```{r}
rel<-aggregate(ts[,!(names(ts) %in% c("V161010e", "version"))], by=list(Rel=ts$V161241), mean)

#rel$V162084

#rel

#pca<-prcomp(rel, scale=T)

#pca



na_count <-sapply(ts, function(y) sum(length(which(y<0))))
na_count["V161010e"]/nrow(ts)

good_names<-names(na_count)[na_count/nrow(ts)<0.1]

rel_na<-sapply(rel, function(y) sum(length(which(is.na(y)))))

bad_names<-names(rel_na)[rel_na>0]

new_rel<-aggregate(ts[,!(names(ts) %in% c(bad_names, "V161010e", "version"))], by=list(Rel=ts$V161241), mean)

pca<-prcomp(new_rel, scale=T)
```

```{r}
#ONLY RUN THIS ONCE OR THE PERCENTS JUST GET SMALLER AND SMALLER,
#or change the code somehow


#columns that have percents in them
percent_cols<-c("VEP.Total.Ballots.Counted", "VEP.Highest.Office", "VAP.Highest.Office", "X..Non.citizen")

#change these columns into decimals
CF_turnout3[, percent_cols]<- apply(CF_turnout3[, percent_cols],2, function(x){
 as.numeric(sub("%", "", x, fixed=TRUE))/100})
CF_turnout3
```
```{r}
#election results by state
results<-read_excel("./Data/G-politicians.xls")
results<-clean_names(results)

dim(results)

#change abb col for matching purposes
colnames(results)[colnames(results)=="state_abbreviation"]<-"Abbreviation"

#fix some weird data so its all D/R
results$balloted_party_ies[(results$balloted_party_ies=="Republican, American Independent")|(results$balloted_party_ies=="Conservative, Republican")]<-"Republican"
results$balloted_party_ies[(results$balloted_party_ies=="Democratic-Nonpartisan League")|(results$balloted_party_ies=="Democratic-Farmer Labor")|(results$balloted_party_ies=="Working Families, Women's Equality, Democratic")]<-"Democratic"

#only take presidential candidates who are D/R
results<-subset(results, (office_abbreviation=="P")&( (balloted_party_ies=="Republican")|(balloted_party_ies=="Democratic")))
```

```{r}
#df with state and margin 
pop_vote<-data.frame(Abbreviation=state_converter1$Abbreviation, margin=NaN)

#for each state, get the votes for each party, subtract them to get difference, add it to the df pop_vote
for (state in state_converter1$Abbreviation){
  dem<-subset(results, (Abbreviation==state)&(balloted_party_ies=="Democratic"), select=popular_vote)
  rep<-subset(results, (Abbreviation==state)&(balloted_party_ies=="Republican"), select=popular_vote)
  m<-dem$popular_vote-rep$popular_vote
  pop_vote$margin[pop_vote$Abbreviation==state]<-m
}

#add who won the popular vote
pop_vote$Winner[pop_vote$margin>0]<-"D"
pop_vote$Winner[pop_vote$margin<0]<-"R"

head(pop_vote)
```

```{r}
#merge vote margin and winner with turnout/CF df

#ISSUE: converting the total votes column (read in as a factor) into a numeric so we can get a percentage (to account for difference in voting populations of each state)

#as.numeric.factor <- function(x) {as.numeric(levels(x))[x]}

#asNumeric <- function(x) as.numeric(as.character(x))
#factorsNumeric <- function(d) modifyList(d, lapply(d[, sapply(d, is.factor)],   
#                                                   asNumeric))


dim(CF_turnout3)
dim(pop_vote)
CF_to_pop<-merge(CF_turnout3, pop_vote, by="Abbreviation")

#CF_to_pop2<-factorsNumeric(CF_to_pop)
#CF_to_pop2
CF_to_pop$Highest.Office<-as.numeric(as.character(gsub( ',', '', CF_to_pop$Highest.Office)))
#CF_to_pop$Highest.Office<-as.numeric(levels(f))[f]
#CF_to_pop
#as.numeric.factor(CF_to_pop$Highest.Office)
CF_to_pop$margin_dec<-CF_to_pop$margin/(CF_to_pop$Highest.Office)

CF_to_pop <- CF_to_pop %>% mutate(CF = Dem.CF + Ind.CF + Rep.CF)

ts_a<-mutate(ts, Abbreviation=V161010e)
ts3<-merge(ts_a, CF_to_pop, by="Abbreviation")
#head(ts3)

CF_to_pop$Abbreviation<-as.character(CF_to_pop$Abbreviation)
head(CF_to_pop)
```

```{r}
#function(x){
#  CF_to_pop[,x]<-as.numeric(as.character(gsub( ',', '', #CF_to_pop[,x])))
#}

asNumeric <- function(x) as.numeric(as.character(gsub(',', '', x)))
#asNumeric(CF_to_pop$VEP)
factorsNumeric <- function(d) modifyList(d, lapply(d[, sapply(d, is.factor)], asNumeric))
CF_to_pop1<-factorsNumeric(CF_to_pop)
CF_to_pop2<-select(CF_to_pop1, -c("State", "Overseas.Eligible", "VEP.Total.Ballots.Counted", "Total.Ballots.Counted", "Abbreviation", "Year", "Region", "Winner"))
CF_to_pop3<-select(CF_to_pop1, -c("State", "Overseas.Eligible", "VEP.Total.Ballots.Counted", "Total.Ballots.Counted","Year"))

cf_na<-sapply(CF_to_pop2, function(y) sum(length(which(is.na(y)))))

dim(CF_to_pop)
dim(CF_to_pop1)

sapply(CF_to_pop2, is.numeric)

library(FactoMineR)
famd<-FAMD(CF_to_pop3, ncp=50)
length(famd$eig[,3])
length(c(1:49))
plot(c(1:49), famd$eig[,3])

famd_lasso<-gamlr(as.data.frame(famd$eig[,1]), CF_to_pop1$VEP.Highest.Office)

pca<-prcomp(CF_to_pop2)
z<-predict(pca)

pca_lasso<-gamlr(as.data.frame(z), CF_to_pop$Winner)
coef(pca_lasso)

```

```{r}
#V161241 <- is religion important
#V161342 <- ~gender~
#V161310a <- white or nah
#V161010e <- state
#V168023 <- income
#V168110 <- est age

list_cols<-c("version", "V160001", "V160001_orig")
weights<-c("V160102", "V160101", "V160102f", "V160101f", "V160102w", "V160101w")
strata_weights<-c("V160201", "V160201f", "V160201w", "V160202", "V160202f", "V160202w")
interview_type<-c("V160501", "V160502")

ts_nl<-select(ts, -c(list_cols, weights, strata_weights, interview_type))


#takes a bit to run
ts_f<-as_factor(ts_nl, only_labelled = T, levels="values")

factor_ts<-Filter(is.factor, ts_f)
numeric_ts<-Filter(is.numeric, ts_f)
```


```{r}
Abbreviation<-ts$V161010e


f_state_ts<-cbind(Abbreviation, factor_ts)


#spread(f_state_ts, f_state_ts$Abbreviation, f_state_ts$V161005)
#prop.table(table(f_state_ts$Abbreviation, f_state_ts[, "V161001"]), 1)
props<-data.frame(Abbreviation=state_converter$Abbreviation)



#d<-as.data.frame.matrix(prop.table(table(f_state_ts$Abbreviation, f_state_ts[, "V161001"]), 1))

#d <- cbind(rownames(d), as.data.frame(d, row.names=NULL))
#colnames(d)[colnames(d)=="rownames(d)"]<-"Abbreviation"
#rownames(d)<-c()

#head(d)

#m<-merge(props, d, by="Abbreviation")

ts_f2<-as_factor(ts_nl, only_labelled = T, levels="values")
factor_ts2<-Filter(is.factor, ts_f2)

na_count <-sapply(factor_ts2, function(y) sum(length(which((y%in%c(-7:-1))))))

good_names<-names(na_count)[na_count==0]
factor_ts3<-select(factor_ts2, c(good_names))
f_state_ts2<-cbind(Abbreviation, factor_ts3)



start_time<-Sys.time()
for (col in names(factor_ts3)){
  pt<-prop.table(table(f_state_ts2$Abbreviation, f_state_ts2[, col]), 1)
  colnames(pt)<-paste(col, colnames(pt), sep="_")
  p<-as.data.frame.matrix(pt)
  p <- cbind(rownames(p), as.data.frame(p, row.names=NULL))
  colnames(p)[colnames(p)=="rownames(p)"]<-"Abbreviation"
  rownames(p)<-c()
  props<-merge(props, p, by="Abbreviation")
  stop_time<-Sys.time()
  print(stop_time-start_time)
}
  
props
```

```{r}
m<-aggregate(numeric_ts, list(Abbreviation), mean)
colnames(m)[colnames(m)=="Group.1"]<-"Abbreviation"
m2<-m[m$Abbreviation!="DC",]
dim(new_ething)
```
 
```{r}
write.csv(props, file="./Data/Prop.csv")
```

```{r}

prop2<-props[props$Abbreviation!="DC", ]
new_ething<-merge(prop2, m2, by="Abbreviation")
everything<-merge(CF_to_pop, new_ething, by="Abbreviation")
write.csv(everything, file="./Data/CF_to_res_ts.csv")
```

LASSO
```{r}
ething<-read.csv("./Data/CF_to_res_ts.csv")
```

```{r}
d<-CF_to_pop$CF
ething2<-as.big.matrix(select(ething, -c("CF", "Dem.CF", "Rep.CF", "Ind.CF")))
treat_blasso<-biglasso(X=ething2, y=d)
#plot(treat_blasso)
#sort(coef(treat_blasso), decreasing = T)[1:10]
big_dhat<-predict(treat_blasso, ething2)

V<-CF_to_pop$VEP.Highest.Office

#cbind(d, dhat, spm)

D<-CF_to_pop$Dem.CF
R<-CF_to_pop$Rep.CF
I<-CF_to_pop$Ind.CF

source("BM.R")

bigd_lasso<-biglasso(cbindBM(as.big.matrix(d),as.big.matrix(as.matrix(big_dhat)),ething2, binding="left"), V)
coef(bigd_lasso)
plot(bigd_lasso)
```

```{r}
dim(ething)
spm <-model.matrix(~., data=ething)[,-1]#[, c("V161241", "V161342", "salt")])[,-1]

#spm2<-spm[,!(state=="DC") ]
#spm2


#dim(tsg2)
#dim(spm)
#length(CF_to_pop$CF)

treat_lasso<-gamlr(spm, d)

dhat<-predict(treat_lasso, )

V<-CF_to_pop$VEP.Highest.Office

#cbind(d, dhat, spm)

D<-CF_to_pop$Dem.CF
R<-CF_to_pop$Rep.CF
I<-CF_to_pop$Ind.CF

d_lasso<-gamlr(cbind(d,dhat,ething2), V, free=2)
coef(d_lasso)
dlasso_plot<-plot(d_lasso)
```
  
Old LASSO stuff, might use it later
```{r}

#use this to get rid of version column if needed

#set up columns to exclude



na_count <-sapply(ts_nl, function(y) sum(length(which(y<0))))
#na_count["V161010e"]/nrow(ts)



good_names<-names(na_count)[na_count/nrow(ts_nl)<0.1]

very_good_names<-names(na_count)[na_count/nrow(ts_nl)==0]

length(very_good_names)


lasso_cols<-c("V161241", "V161342", "V161310a")

good_lasso_cols<-c("V161241", "V161342")

cont_lasso_cols<-c("V168023")

#count(ts$V168023==1)
count(ts$V168023)
count(ts$V168023)$freq[3]

for (val in c(1:length(count(ts$V168023)$x))){
  print(val)
  print(count(ts$V168023)$freq[val]/sum(count(ts$V168023)$freq))
}

tsg<-aggregate(na.omit(ts_nl[,very_good_names]), by=list(State=ts$V161010e), function(x){for (val in c(1:length(count(x)$x))){(count(x)$freq[val])/(sum(count(x)$freq))}})

tsg

#tsg1<-aggegate(na.omit(ts[ ]))

#tsg2<-tsg[tsg$State!="DC",] %>%
#  mutate(salt = replace_na(V161310a, 0)) %>%
#  select(-c(V161310a, State))

#head(tsg2)

#tsg <- mutate(ts, perrel = group_by(V161010e, count(V161241=1)))


```


```{r}
ftf<-read.delim("./Data/ftf-all-filings.tsv")
```

```{r}
ftf$gross_amount[ftf$committee=="NRA POLITICAL VICTORY FUND"]
```



```{r}
#decision tree with finances
tree_ex<-tree(as.numeric(VEP.Highest.Office)~Dem.CF+Rep.CF+Ind.CF, data=CF_turnout3)
plot(tree_ex)
text(tree_ex)

```

```{r}
ething$Abbreviation[which.max(ething$VEP.Highest.Office)]
```

PLOTS
```{r}
jpeg("./Plots/VEP_hist.jpeg")
hist(ething$VEP.Highest.Office, xlab = "Voter Turnout", main = "Turnout Distribution, 2016")
dev.off()

jpeg("./Plots/Dem_spending.jpeg")
hist(ething$Dem.CF/ething$CF*100, main="Percent of All Spending, Democrats", xlab = "Democrat Percentage")
dev.off()
jpeg("./Plots/Rep_spending.jpeg")
hist(ething$Rep.CF/ething$CF*100, main="Percent of All Spending, Republican", xlab = "Republican Percentage")
dev.off()
jpeg("./Plots/Ind_spending.jpeg")
hist(ething$Ind.CF/ething$CF*100, main="Percent of All Spending, Independents", xlab = "Independent Percentage")
dev.off()

jpeg("./Plots/spendingvsto")
plot(ething$VEP.Highest.Office, ething$CF, xlab = "Turnout", ylab = "Total Spending", main="Spending vs Turnout")
dev.off()
```